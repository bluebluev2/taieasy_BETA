# ⚡ 台電送件小幫手 (BETA) - 資料欄位與功能說明書

本文件說明「台電送件小幫手」系統的資料匯入格式、自動化判斷邏輯以及匯出報表的欄位定義。

---

## 📂 1. 核心運作邏輯

本系統的核心在於透過 **台帳圖號座標 (G-code)** 將「換裝資料」與「台電既設台帳」進行自動比對。

* **主要關聯鍵 (Key)**：`G-code`
* **運作方式**：系統會讀取 **路燈資料** 中的 `G-code_1st` 欄位，去搜尋 **參考點資料** 中的 `G-code`。
* **目的**：自動取得該路燈的「舊有燈種」與「既設容量」，以程式邏輯自動判斷案件類別（如：器變、容變）。

---

## 📥 2. 輸入檔案說明

### A. 參考 G-Code 資料 (綠點)
* **用途**：作為「台電既設台帳」的資料庫。
* **視覺呈現**：地圖上的 **綠色圓點**。
* **範例檔名**：`G-code_G5050.csv` (或包含 G-code 資訊的 CSV)

| 欄位名稱 (Header) | 必填 | 說明與用途 |
| :--- | :---: | :--- |
| **G-code** | ✅ | **[關鍵索引]** 既設路燈的唯一座標代碼，用於被搜尋。 |
| **G-x** | ✅ | TWD97 X座標 (或經度)，定位綠點位置。 |
| **G-y** | ✅ | TWD97 Y座標 (或緯度)，定位綠點位置。 |
| **G-W** | ✅ | **既設燈具類型** (如 "鈉光燈", "LED")。<br>系統依此欄位關鍵字判斷：<br>1. 含 "鈉光燈" ➔ 判為 **器變**<br>2. 含 "LED" ➔ 判為 **容變** |
| **G-VA** | ⚪ | **既設容量** (如 "134")。<br>若有此值，將優先作為 Excel 報表中的「變更前台帳容量」。 |

---

### B. 路燈資料匯入 (紅圈)
* **用途**：換裝資料。
* **視覺呈現**：地圖上的 **紅色圓圈** 與 **文字標籤**。
* **範例檔名**：`浚榮換裝_260115_G5050.csv`

| 欄位名稱 (Header) | 必填 | 說明與用途 |
| :--- | :---: | :--- |
| **name** | ✅ | 路燈編號，顯示於地圖標籤上。 |
| **x** | ✅ | 經度 (Longitude)，紅圈中心位置。 |
| **y** | ✅ | 緯度 (Latitude)，紅圈中心位置。 |
| **G-code_1st** | ⚪ | **[關聯鍵]** 對應的台帳 G-code。<br>若留空，系統自動視為「**增設**」案件。 |
| **變更後容量(VA)** | ⚪ | 換裝後 LED 容量 (如 "73")。<br>1. 地圖標籤會自動補上 "VA" (如 73VA)。<br>2. Excel 統計分類的主要依據。 |
| **群組名稱** | ⚪ | 填入 Excel 登記單的「行政區」欄位。 |
| **路燈位置** | ⚪ | 填入 Excel 登記單的「裝設位置或地址」欄位。 |
| **燈泡瓦數** | ⚪ | (備用) 若「變更後容量」為空，系統會嘗試讀取此欄位作為規格依據。 |

---

## ⚙️ 3. 自動化判斷邏輯

當資料匯入後，程式會依據下列順序自動標記案件類型：

1.  **增設**：`G-code_1st` 欄位為空。
2.  **待確認**：有填寫 `G-code_1st`，但在「參考 G-Code 資料」中找不到對應資料。
3.  **器變**：對應到的參考資料 `G-W` 欄位包含「鈉光燈」。
4.  **容變**：對應到的參考資料 `G-W` 欄位包含「LED」。

---

## 📤 4. 匯出檔案說明

### 📊 Excel 登記單
依據台電送件需求產生的報表，包含兩個工作表：

#### **Sheet 1: 登記單(正面) - 統計匯總**
* **每具容量**：顯示 `變更後容量(VA)` 的規格。
* **既設數量**：統計該規格下，變更前的舊燈具數量。
* **容量計算公式**：
    > 既設容量顯示值 = `Math.ceil( 原始舊容量 / 0.9 )` + "VA"
    > *(例：250W -> 250/0.9=277.7 -> 進位顯示 278VA)*

#### **Sheet 2: 路燈汰換明細表**
* 列出所有紅圈的詳細清單。
* 包含欄位：行政區、裝設位置、台帳圖號座標、路燈編號、變更前後燈別與容量。

### 🗺️ 匯出圖層 PDF (施工圖說)
將網頁上的標記直接「燒」錄進原始 PDF 底圖中，可作為施工圖或驗收依據。

* **內容包含**：
    * 原始上傳的台帳圖資 PDF。
    * **紅圈** (換裝位置) 與 **文字標籤** (路燈編號+規格)。
    * **手動繪圖** 的內容 (自訂註記文字、畫線、畫圓)。
* **重要特性**：
    * **所見即所得**：PDF 產出結果會 **連動目前的篩選狀態**。
    * *例如：若目前篩選器選擇「器變」，匯出的 PDF 就只會顯示器變的紅圈，不會顯示其他案件。*

---

### 💾 JSON 專案檔
* **用途**：完整備份目前的工作狀態 (包含手繪圖層)。
* **內容**：
    * 所有路燈資料 (紅圈、屬性、半徑)。
    * 所有手繪標記 (線條、圓圈、文字)。
    * PDF 底圖的定位座標。
* **建議**：每日作業結束請務必匯出 JSON，下次直接「載入專案」即可恢復所有進度。
